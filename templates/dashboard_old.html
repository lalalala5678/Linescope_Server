<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数据仪表盘 · Linescope Server</title>
  <meta name="description" content="实时传感器数据分析与可视化仪表盘">
  
  <!-- Modern CSS Framework - Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  
  <!-- Advanced Chart Library - Apache ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  
  <!-- Modern Icons - Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <!-- Advanced Animations -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  
  <!-- Data Grid Library -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/dist/ag-grid-community.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.0/styles/ag-theme-alpine-dark.css">
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  
  <style>
    * { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      color: #f8fafc;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px);
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .data-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s ease;
    }
    
    .data-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(148, 163, 184, 0.2);
    }
    
    .chart-container {
      height: 400px;
      position: relative;
    }
    
    .metric-big {
      font-size: 3rem;
      font-weight: 800;
      line-height: 1;
    }
    
    .status-indicator {
      animation: pulse-status 2s infinite;
    }
    
    @keyframes pulse-status {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .grid-container {
      height: 600px;
      width: 100%;
    }
    
    .ag-theme-alpine-dark {
      --ag-background-color: rgba(30, 41, 59, 0.8);
      --ag-header-background-color: rgba(15, 23, 42, 0.9);
      --ag-odd-row-background-color: rgba(30, 41, 59, 0.3);
      --ag-border-color: rgba(148, 163, 184, 0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .trend-up {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }
    
    .trend-down {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
    
    .trend-stable {
      background: rgba(156, 163, 175, 0.1);
      color: #9ca3af;
    }
    
    .mini-chart {
      height: 60px;
      width: 100%;
    }
    
    .alert-high {
      animation: alert-flash 1s infinite;
    }
    
    @keyframes alert-flash {
      0%, 100% { background-color: rgba(239, 68, 68, 0.1); }
      50% { background-color: rgba(239, 68, 68, 0.2); }
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen gradient-bg text-white">
  <!-- Navigation -->
  <nav class="glass-effect border-b border-gray-600/20 sticky top-0 z-50" data-aos="fade-down">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
            <i data-lucide="bar-chart-3" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">数据仪表盘</h1>
            <p class="text-sm text-gray-300">实时传感器数据分析</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <div class="flex items-center space-x-2 px-4 py-2 glass-effect rounded-lg">
            <div class="w-2 h-2 bg-green-500 rounded-full status-indicator"></div>
            <span class="text-sm text-gray-300">实时连接</span>
          </div>
          <a href="/" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all duration-300 flex items-center space-x-2">
            <i data-lucide="home" class="w-4 h-4"></i>
            <span>首页</span>
          </a>
          <a href="/result" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all duration-300 flex items-center space-x-2">
            <i data-lucide="video" class="w-4 h-4"></i>
            <span>视频</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Dashboard -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header Section -->
    <section class="mb-8" data-aos="fade-up">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-4xl font-bold text-white mb-2">传感器监控中心</h1>
          <p class="text-lg text-gray-300">实时监测电力线缆运行状态与环境参数</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center space-x-4">
          <div class="text-right">
            <div class="text-sm text-gray-400">最后更新</div>
            <div class="text-lg font-semibold text-white" id="last-update">--:--:--</div>
          </div>
          <button id="refresh-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition-all duration-300 flex items-center space-x-2">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            <span>刷新数据</span>
          </button>
        </div>
      </div>
    </section>

    <!-- KPI Cards -->
    <section class="mb-8" data-aos="fade-up" data-aos-delay="100">
      <div class="stats-grid">
        <!-- Temperature -->
        <div class="data-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="thermometer" class="w-6 h-6 text-blue-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">温度</h3>
                <p class="text-sm text-gray-400">环境温度监测</p>
              </div>
            </div>
            <div class="trend-indicator trend-stable" id="temp-trend">
              <i data-lucide="minus" class="w-3 h-3"></i>
              <span>0.0%</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="metric-big text-blue-400" id="temp-current">--°C</div>
            <div class="text-sm text-gray-400">
              范围: <span id="temp-range">-- ~ --°C</span>
            </div>
          </div>
          <div class="mini-chart">
            <div id="temp-mini-chart"></div>
          </div>
        </div>

        <!-- Humidity -->
        <div class="data-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="droplets" class="w-6 h-6 text-green-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">湿度</h3>
                <p class="text-sm text-gray-400">相对湿度监测</p>
              </div>
            </div>
            <div class="trend-indicator trend-stable" id="humidity-trend">
              <i data-lucide="minus" class="w-3 h-3"></i>
              <span>0.0%</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="metric-big text-green-400" id="humidity-current">--%</div>
            <div class="text-sm text-gray-400">
              范围: <span id="humidity-range">-- ~ --%</span>
            </div>
          </div>
          <div class="mini-chart">
            <div id="humidity-mini-chart"></div>
          </div>
        </div>

        <!-- Pressure -->
        <div class="data-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="gauge" class="w-6 h-6 text-purple-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">气压</h3>
                <p class="text-sm text-gray-400">大气压力监测</p>
              </div>
            </div>
            <div class="trend-indicator trend-stable" id="pressure-trend">
              <i data-lucide="minus" class="w-3 h-3"></i>
              <span>0.0%</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="metric-big text-purple-400" id="pressure-current">-- hPa</div>
            <div class="text-sm text-gray-400">
              范围: <span id="pressure-range">-- ~ -- hPa</span>
            </div>
          </div>
          <div class="mini-chart">
            <div id="pressure-mini-chart"></div>
          </div>
        </div>

        <!-- Light -->
        <div class="data-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="sun" class="w-6 h-6 text-yellow-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">光照</h3>
                <p class="text-sm text-gray-400">环境光照强度</p>
              </div>
            </div>
            <div class="trend-indicator trend-stable" id="lux-trend">
              <i data-lucide="minus" class="w-3 h-3"></i>
              <span>0.0%</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="metric-big text-yellow-400" id="lux-current">-- Lux</div>
            <div class="text-sm text-gray-400">
              范围: <span id="lux-range">-- ~ -- Lux</span>
            </div>
          </div>
          <div class="mini-chart">
            <div id="lux-mini-chart"></div>
          </div>
        </div>

        <!-- Sway Speed -->
        <div class="data-card rounded-2xl p-6" id="sway-card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="move" class="w-6 h-6 text-red-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">晃动速度</h3>
                <p class="text-sm text-gray-400">线缆摆动监测</p>
              </div>
            </div>
            <div class="trend-indicator trend-stable" id="sway-trend">
              <i data-lucide="minus" class="w-3 h-3"></i>
              <span>0.0%</span>
            </div>
          </div>
          <div class="mb-4">
            <div class="metric-big text-red-400" id="sway-current">-- °/s</div>
            <div class="text-sm text-gray-400">
              范围: <span id="sway-range">-- ~ -- °/s</span>
            </div>
          </div>
          <div class="mini-chart">
            <div id="sway-mini-chart"></div>
          </div>
        </div>

        <!-- System Status -->
        <div class="data-card rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-indigo-500/20 rounded-xl flex items-center justify-center">
                <i data-lucide="activity" class="w-6 h-6 text-indigo-400"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-white">系统状态</h3>
                <p class="text-sm text-gray-400">监测系统运行状态</p>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-300">数据点总数</span>
              <span class="text-white font-semibold" id="total-records">--</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-300">数据采集频率</span>
              <span class="text-white font-semibold">30分钟/次</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-300">系统运行时间</span>
              <span class="text-white font-semibold" id="uptime">计算中...</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-300">连接状态</span>
              <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-500 rounded-full status-indicator"></div>
                <span class="text-green-400 font-semibold">正常</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Charts Section -->
    <section class="grid lg:grid-cols-2 gap-8 mb-8" data-aos="fade-up" data-aos-delay="200">
      <!-- Combined Environmental Chart -->
      <div class="data-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-white">环境参数趋势</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <i data-lucide="trending-up" class="w-4 h-4"></i>
            <span>24小时趋势</span>
          </div>
        </div>
        <div class="chart-container">
          <div id="environmental-chart"></div>
        </div>
      </div>

      <!-- Sway Analysis Chart -->
      <div class="data-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-white">晃动分析</h3>
          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            <span>异常检测</span>
          </div>
        </div>
        <div class="chart-container">
          <div id="sway-chart"></div>
        </div>
      </div>
    </section>

    <!-- Data Grid -->
    <section class="mb-8" data-aos="fade-up" data-aos-delay="300">
      <div class="data-card rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-white">历史数据记录</h3>
          <div class="flex items-center space-x-4">
            <button id="export-csv" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white text-sm font-medium transition-all duration-300 flex items-center space-x-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              <span>导出CSV</span>
            </button>
            <div class="text-sm text-gray-400">
              共 <span id="total-rows" class="text-white font-semibold">--</span> 条记录
            </div>
          </div>
        </div>
        <div class="grid-container ag-theme-alpine-dark">
          <div id="data-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- 传递服务端数据到前端 -->
  {% if data_json %}
  <script>
    // 设置服务端数据供新的模块化系统使用
    window.initialData = {{ data_json|safe }};
  </script>
  {% endif %}
  
  <!-- 现代化模块化JavaScript -->
  <script type="module">
    // 初始化外部库
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化Lucide图标
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    AOS.init({
      duration: 800,
      once: true,
      offset: 100
    });

    // Global variables
    let sensorData = [];
    
    // Initialize with server-side data if available
    {% if data_json %}
    try {
      window.initialData = {{ data_json|safe }};
      sensorData = window.initialData;
      console.log(`Initialized with server-side data: ${sensorData.length} records`);
    } catch (error) {
      console.error('Error parsing server-side data:', error);
    }
    {% endif %}
    let environmentalChart = null;
    let swayChart = null;
    let miniCharts = {};
    let dataGrid = null;
    let previousValues = {};

    // Utility functions
    const formatNumber = (num, precision = 2) => {
      if (num === null || num === undefined || isNaN(num)) return '--';
      return Number(num).toFixed(precision);
    };

    const calculateTrend = (current, previous) => {
      if (!previous || previous === 0) return { percentage: 0, direction: 'stable' };
      const change = ((current - previous) / previous) * 100;
      const direction = Math.abs(change) < 1 ? 'stable' : change > 0 ? 'up' : 'down';
      return { percentage: Math.abs(change), direction };
    };

    const updateTrendIndicator = (elementId, trend) => {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      element.className = `trend-indicator trend-${trend.direction}`;
      element.innerHTML = `
        <i data-lucide="${trend.direction === 'up' ? 'trending-up' : trend.direction === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3"></i>
        <span>${trend.percentage.toFixed(1)}%</span>
      `;
      lucide.createIcons();
    };

    // Data fetching
    const fetchSensorData = async () => {
      try {
        const response = await fetch('/api/sensor-data');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          console.warn('API returned non-array data:', data);
          sensorData = [];
          return;
        }
        
        sensorData = data;
        console.log(`Fetched ${sensorData.length} sensor records`);
        
        updateKPIs();
        updateCharts();
        updateDataGrid();
        
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        document.getElementById('total-records').textContent = sensorData.length;
        
      } catch (error) {
        console.error('Error fetching sensor data:', error);
        showError(`数据获取失败: ${error.message}`);
        
        // Try to use server-side data if available
        if (typeof window.initialData !== 'undefined' && window.initialData) {
          try {
            sensorData = window.initialData;
            console.log(`Using server-side data, ${sensorData.length} records`);
            updateKPIs();
            updateCharts();
            updateDataGrid();
          } catch (parseError) {
            console.error('Error using server-side data:', parseError);
          }
        }
      }
    };

    // KPI Updates
    const updateKPIs = () => {
      if (sensorData.length === 0) return;
      
      const latest = sensorData[sensorData.length - 1];
      const previous = sensorData.length > 1 ? sensorData[sensorData.length - 2] : null;
      
      // Update current values and trends
      const metrics = ['temperature_C', 'humidity_RH', 'pressure_hPa', 'lux', 'sway_speed_dps'];
      const labels = ['temp', 'humidity', 'pressure', 'lux', 'sway'];
      const units = ['°C', '%', ' hPa', ' Lux', ' °/s'];
      
      metrics.forEach((metric, index) => {
        const label = labels[index];
        const unit = units[index];
        const current = latest[metric];
        const prev = previous ? previous[metric] : null;
        
        // Update current value
        document.getElementById(`${label}-current`).textContent = formatNumber(current) + unit;
        
        // Update trend
        const trend = calculateTrend(current, prev);
        updateTrendIndicator(`${label}-trend`, trend);
        
        // Calculate range
        const values = sensorData.map(d => d[metric]).filter(v => v !== null && !isNaN(v));
        if (values.length > 0) {
          const min = Math.min(...values);
          const max = Math.max(...values);
          document.getElementById(`${label}-range`).textContent = 
            `${formatNumber(min)} ~ ${formatNumber(max)}${unit}`;
        }
      });
      
      // Special handling for sway speed alerts
      const swayCard = document.getElementById('sway-card');
      if (latest.sway_speed_dps > 60) {
        swayCard.classList.add('alert-high');
      } else {
        swayCard.classList.remove('alert-high');
      }
      
      // Update mini charts
      updateMiniCharts();
    };

    // Mini Charts
    const updateMiniCharts = () => {
      const metrics = [
        { key: 'temperature_C', id: 'temp-mini-chart', color: '#60a5fa' },
        { key: 'humidity_RH', id: 'humidity-mini-chart', color: '#34d399' },
        { key: 'pressure_hPa', id: 'pressure-mini-chart', color: '#a78bfa' },
        { key: 'lux', id: 'lux-mini-chart', color: '#fbbf24' },
        { key: 'sway_speed_dps', id: 'sway-mini-chart', color: '#f87171' }
      ];
      
      const recentData = sensorData.slice(-20); // Last 20 points
      
      metrics.forEach(metric => {
        const values = recentData.map(d => d[metric]);
        const times = recentData.map(d => d.timestamp_Beijing);
        
        if (miniCharts[metric.id]) {
          miniCharts[metric.id].dispose();
        }
        
        const chartElement = document.getElementById(metric.id);
        if (!chartElement) {
          console.warn(`Mini chart container ${metric.id} not found`);
          return;
        }
        
        const chart = echarts.init(chartElement);
        miniCharts[metric.id] = chart;
        
        chart.setOption({
          backgroundColor: 'transparent',
          grid: { left: 0, right: 0, top: 0, bottom: 0 },
          xAxis: { type: 'category', data: times, show: false },
          yAxis: { type: 'value', show: false },
          series: [{
            type: 'line',
            data: values,
            smooth: true,
            symbol: 'none',
            lineStyle: { color: metric.color, width: 2 },
            areaStyle: { color: metric.color, opacity: 0.1 }
          }]
        });
      });
    };

    // Main Charts
    const updateCharts = () => {
      updateEnvironmentalChart();
      updateSwayChart();
    };

    const updateEnvironmentalChart = () => {
      const container = document.getElementById('environmental-chart');
      
      if (!container) {
        console.warn('Environmental chart container not found');
        return;
      }
      
      if (typeof echarts === 'undefined') {
        console.warn('ECharts library not loaded');
        return;
      }
      
      if (sensorData.length === 0) {
        console.warn('No data available for environmental chart');
        return;
      }
      
      console.log('Creating environmental chart with', sensorData.length, 'data points');
      
      if (environmentalChart) {
        environmentalChart.dispose();
      }
      
      environmentalChart = echarts.init(container);
      
      const times = sensorData.map(d => d.timestamp_Beijing);
      
      const option = {
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: 'rgba(148, 163, 184, 0.2)',
          textStyle: { color: '#fff' }
        },
        legend: {
          data: ['温度', '湿度', '气压'],
          textStyle: { color: '#e2e8f0' },
          top: 10
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: times,
          axisLabel: {
            color: '#94a3b8',
            formatter: function(value) {
              return value.split(' ')[1] || value;
            }
          },
          axisLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.2)' } }
        },
        yAxis: [
          {
            type: 'value',
            name: '温度 (°C) / 湿度 (%)',
            axisLabel: { color: '#94a3b8' },
            axisLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.2)' } },
            splitLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.1)' } }
          },
          {
            type: 'value',
            name: '气压 (hPa)',
            axisLabel: { color: '#94a3b8' },
            axisLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.2)' } }
          }
        ],
        series: [
          {
            name: '温度',
            type: 'line',
            data: sensorData.map(d => d.temperature_C),
            smooth: true,
            lineStyle: { color: '#60a5fa', width: 2 },
            areaStyle: { color: 'rgba(96, 165, 250, 0.1)' }
          },
          {
            name: '湿度',
            type: 'line',
            data: sensorData.map(d => d.humidity_RH),
            smooth: true,
            lineStyle: { color: '#34d399', width: 2 },
            areaStyle: { color: 'rgba(52, 211, 153, 0.1)' }
          },
          {
            name: '气压',
            type: 'line',
            yAxisIndex: 1,
            data: sensorData.map(d => d.pressure_hPa),
            smooth: true,
            lineStyle: { color: '#a78bfa', width: 2 },
            areaStyle: { color: 'rgba(167, 139, 250, 0.1)' }
          }
        ]
      };
      
      environmentalChart.setOption(option);
    };

    const updateSwayChart = () => {
      const container = document.getElementById('sway-chart');
      
      if (!container) {
        console.warn('Sway chart container not found');
        return;
      }
      
      if (typeof echarts === 'undefined') {
        console.warn('ECharts library not loaded');
        return;
      }
      
      if (sensorData.length === 0) {
        console.warn('No data available for sway chart');
        return;
      }
      
      console.log('Creating sway chart with', sensorData.length, 'data points');
      
      if (swayChart) {
        swayChart.dispose();
      }
      
      swayChart = echarts.init(container);
      
      const times = sensorData.map(d => d.timestamp_Beijing);
      const swayData = sensorData.map(d => d.sway_speed_dps);
      
      // Alert threshold
      const alertData = swayData.map(v => v > 60 ? v : null);
      
      const option = {
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          borderColor: 'rgba(148, 163, 184, 0.2)',
          textStyle: { color: '#fff' }
        },
        legend: {
          data: ['晃动速度', '异常阈值', '超标数据'],
          textStyle: { color: '#e2e8f0' },
          top: 10
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: times,
          axisLabel: {
            color: '#94a3b8',
            formatter: function(value) {
              return value.split(' ')[1] || value;
            }
          },
          axisLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.2)' } }
        },
        yAxis: {
          type: 'value',
          name: '晃动速度 (°/s)',
          axisLabel: { color: '#94a3b8' },
          axisLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.2)' } },
          splitLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.1)' } }
        },
        series: [
          {
            name: '晃动速度',
            type: 'line',
            data: swayData,
            smooth: true,
            lineStyle: { color: '#f87171', width: 2 },
            areaStyle: { color: 'rgba(248, 113, 113, 0.1)' }
          },
          {
            name: '异常阈值',
            type: 'line',
            data: new Array(times.length).fill(60),
            lineStyle: { 
              color: '#ef4444', 
              width: 2, 
              type: 'dashed' 
            },
            symbol: 'none'
          },
          {
            name: '超标数据',
            type: 'scatter',
            data: alertData.map((v, i) => v !== null ? [i, v] : null).filter(v => v !== null),
            symbolSize: 8,
            itemStyle: { color: '#dc2626' }
          }
        ]
      };
      
      swayChart.setOption(option);
    };

    // Data Grid
    const updateDataGrid = () => {
      const columnDefs = [
        { 
          field: 'timestamp_Beijing', 
          headerName: '时间戳', 
          width: 150,
          cellRenderer: (params) => {
            return `<span style="font-family: monospace;">${params.value}</span>`;
          }
        },
        { 
          field: 'sway_speed_dps', 
          headerName: '晃动速度 (°/s)', 
          width: 130,
          type: 'numericColumn',
          cellRenderer: (params) => {
            const value = formatNumber(params.value);
            const isHigh = params.value > 60;
            return `<span class="${isHigh ? 'text-red-400 font-bold' : 'text-white'}">${value}</span>`;
          }
        },
        { 
          field: 'temperature_C', 
          headerName: '温度 (°C)', 
          width: 120,
          type: 'numericColumn',
          cellRenderer: (params) => formatNumber(params.value)
        },
        { 
          field: 'humidity_RH', 
          headerName: '湿度 (%)', 
          width: 120,
          type: 'numericColumn',
          cellRenderer: (params) => formatNumber(params.value)
        },
        { 
          field: 'pressure_hPa', 
          headerName: '气压 (hPa)', 
          width: 130,
          type: 'numericColumn',
          cellRenderer: (params) => formatNumber(params.value)
        },
        { 
          field: 'lux', 
          headerName: '光照 (Lux)', 
          width: 120,
          type: 'numericColumn',
          cellRenderer: (params) => formatNumber(params.value, 0)
        }
      ];

      const gridOptions = {
        columnDefs: columnDefs,
        rowData: sensorData.slice().reverse(), // Show latest first
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true
        },
        pagination: true,
        paginationPageSize: 20,
        animateRows: true,
        getRowStyle: (params) => {
          if (params.data.sway_speed_dps > 60) {
            return { backgroundColor: 'rgba(239, 68, 68, 0.1)' };
          }
          return null;
        }
      };

      const gridDiv = document.querySelector('#data-grid');
      if (dataGrid) {
        dataGrid.destroy();
      }
      
      dataGrid = new agGrid.Grid(gridDiv, gridOptions);
      document.getElementById('total-rows').textContent = sensorData.length;
    };

    // Export functionality
    const exportToCSV = () => {
      if (sensorData.length === 0) {
        showError('没有数据可导出');
        return;
      }
      
      const headers = ['时间戳', '晃动速度(°/s)', '温度(°C)', '湿度(%)', '气压(hPa)', '光照(Lux)'];
      const csvContent = [
        headers.join(','),
        ...sensorData.map(row => [
          row.timestamp_Beijing,
          formatNumber(row.sway_speed_dps),
          formatNumber(row.temperature_C),
          formatNumber(row.humidity_RH),
          formatNumber(row.pressure_hPa),
          formatNumber(row.lux, 0)
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `sensor-data-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Error handling
    const showError = (message) => {
      // Simple error display - could be enhanced with a proper notification system
      console.error(message);
      alert(message);
    };

    // Calculate uptime
    const updateUptime = () => {
      // This is a simple uptime calculation - in a real app you'd get this from the server
      const startTime = new Date('2025-01-01').getTime();
      const now = new Date().getTime();
      const uptime = now - startTime;
      
      const days = Math.floor(uptime / (1000 * 60 * 60 * 24));
      const hours = Math.floor((uptime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      
      document.getElementById('uptime').textContent = `${days}天 ${hours}小时`;
    };

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', () => {
      const button = document.getElementById('refresh-btn');
      button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>加载中...</span>';
      lucide.createIcons();
      
      fetchSensorData().finally(() => {
        button.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i><span>刷新数据</span>';
        lucide.createIcons();
      });
    });

    document.getElementById('export-csv').addEventListener('click', exportToCSV);

    // Window resize handler
    window.addEventListener('resize', () => {
      if (environmentalChart) environmentalChart.resize();
      if (swayChart) swayChart.resize();
      Object.values(miniCharts).forEach(chart => chart.resize());
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      // If we have initial data, update the UI immediately
      if (sensorData.length > 0) {
        console.log('Updating UI with initial data:', sensorData.length, 'records');
        updateKPIs();
        
        // Add delay to ensure ECharts is ready
        setTimeout(() => {
          updateCharts();
        }, 200);
        
        updateDataGrid();
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        document.getElementById('total-records').textContent = sensorData.length;
      }
      
      // Always try to fetch fresh data
      fetchSensorData();
      updateUptime();
      
      // Auto-refresh every 5 minutes
      setInterval(fetchSensorData, 5 * 60 * 1000);
      
      // Update uptime every minute
      setInterval(updateUptime, 60 * 1000);
    });
  </script>
</body>
</html>