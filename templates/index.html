<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linescope Server · 智能线缆监测平台</title>
  <meta name="description" content="基于STM32与Python的智能线缆监测系统">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Linescope">
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icon-32x32.ico') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-32x32.ico') }}">
  
  <!-- DNS预解析和预连接优化 -->
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  
  <!-- 关键资源预加载 -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" as="script">
  <link rel="preload" href="{{ url_for('static', filename='js/app.js') }}" as="script" crossorigin="anonymous">
  
  <!-- Inter Font with optimized loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'; this.onload=null;">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
  
  <!-- Critical CSS inline for first paint -->
  <style>
    /* Critical path CSS for first paint */
    body { font-family: system-ui, -apple-system, sans-serif; }
    .loading { opacity: 0; animation: fadeIn 0.3s ease-in-out 0.1s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
  </style>
  
  <!-- 非关键CSS异步加载 -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" media="print" onload="this.media='all'; this.onload=null;">
  <noscript><link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet"></noscript>
  
  <!-- Modern CSS Framework - Tailwind CSS with fallback -->
  <script async src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio" onerror="this.onerror=null; console.warn('Tailwind CSS failed to load')"></script>
  
  <!-- Modern Chart Library - Apache ECharts with error handling -->
  <script async src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" onerror="this.onerror=null; window.echartsLoadError=true; console.warn('ECharts failed to load')"></script>
  
  <!-- Modern Icons - Lucide Icons with fallback -->
  <script async src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" onerror="this.onerror=null; window.lucideLoadError=true; console.warn('Lucide icons failed to load')"></script>
  
  <!-- Custom Animations with fallback -->
  <script async src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js" onerror="this.onerror=null; window.aosLoadError=true; console.warn('AOS animations failed to load')"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  
  <style>
    * { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
    }
    
    /* Enhanced glass morphism with better contrast */
    .glass-card {
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transform: translateZ(0);
      will-change: transform;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px) saturate(180%);
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateZ(0);
    }
    
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }
    
    .pulse-dot {
      animation: pulse-dot 2s infinite;
    }
    
    @keyframes pulse-dot {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    .metric-card {
      background: linear-gradient(145deg, rgba(15,23,42,0.6), rgba(15,23,42,0.4));
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateZ(0);
      will-change: transform;
    }
    
    .metric-card:hover {
      background: linear-gradient(145deg, rgba(15,23,42,0.7), rgba(15,23,42,0.5));
      transform: translateY(-4px) translateZ(0);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
      contain: layout style paint;
      transform: translateZ(0);
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#667eea',
            secondary: '#764ba2',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen gradient-bg">
  <!-- Navigation -->
  <nav class="glass-effect border-b border-white/20 sticky top-0 z-50" data-aos="fade-down">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-white/20 to-white/10 rounded-xl flex items-center justify-center">
            <i data-lucide="activity" class="w-6 h-6 text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">Linescope Server</h1>
            <p class="text-sm text-white/70">智能线缆监测平台</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <a href="/dashboard" class="px-6 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-white font-medium transition-all duration-300 flex items-center space-x-2">
            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
            <span>数据仪表盘</span>
          </a>
          <a href="/result" class="px-6 py-2 bg-white hover:bg-white/90 rounded-lg text-gray-800 font-medium transition-all duration-300 flex items-center space-x-2">
            <i data-lucide="video" class="w-4 h-4"></i>
            <span>视频监控</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <section class="text-center mb-16" data-aos="fade-up">
      <div class="mb-6">
        <div class="inline-flex items-center px-4 py-2 glass-effect rounded-full mb-6">
          <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot mr-2"></div>
          <span class="text-white/90 text-sm font-medium">系统运行中</span>
        </div>
      </div>
      
      <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight">
        智能<span class="gradient-text">线缆监测</span><br>
        新一代解决方案
      </h1>
      <p class="text-xl text-white/80 max-w-3xl mx-auto leading-relaxed">
        基于STM32微控制器、多传感器融合技术，实现电力线缆的智能化监测与预警，
        确保电网安全稳定运行。
      </p>
    </section>

    <!-- Real-time Metrics -->
    <section class="mb-16" data-aos="fade-up" data-aos-delay="200">
      <h2 class="text-3xl font-bold text-white mb-8 text-center">实时监测数据</h2>
      
      <div class="stats-grid mb-8">
        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="thermometer" class="w-6 h-6 text-blue-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="temp-value">--°C</div>
              <div class="text-sm text-white/60">温度</div>
            </div>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-1000" 
                 id="temp-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="droplets" class="w-6 h-6 text-green-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="humidity-value">--%</div>
              <div class="text-sm text-white/60">湿度</div>
            </div>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all duration-1000" 
                 id="humidity-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="gauge" class="w-6 h-6 text-purple-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="pressure-value">-- hPa</div>
              <div class="text-sm text-white/60">气压</div>
            </div>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full transition-all duration-1000" 
                 id="pressure-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="sun" class="w-6 h-6 text-yellow-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="lux-value">-- Lux</div>
              <div class="text-sm text-white/60">光照</div>
            </div>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full transition-all duration-1000" 
                 id="lux-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="move" class="w-6 h-6 text-red-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="sway-value">-- °/s</div>
              <div class="text-sm text-white/60">晃动速度</div>
            </div>
          </div>
          <div class="h-2 bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-red-400 to-red-600 rounded-full transition-all duration-1000" 
                 id="sway-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-cyan-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="wind" class="w-6 h-6 text-cyan-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="wind-current">-- m/s</div>
              <div class="text-sm text-white/60">10分钟平均风速</div>
            </div>
          </div>
          <div class="space-y-2 text-sm text-white/60">
            <div>范围: <span id="wind-range">-- ~ -- m/s</span></div>
            <div>风向: <span id="wind-direction-value">--°</span></div>
            <div>最大 / 极大: <span id="wind-max-value">-- m/s</span> / <span id="wind-extreme-value">-- m/s</span></div>
            <div>设备编号: <span id="component-id-value">--</span></div>
          </div>
        </div>

        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-sky-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="cloud-rain" class="w-6 h-6 text-sky-400"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white" id="precipitation-current">-- mm</div>
              <div class="text-sm text-white/60">降水</div>
            </div>
          </div>
          <div class="space-y-2 text-sm text-white/60">
            <div>范围: <span id="precipitation-range">-- ~ -- mm</span></div>
            <div>降水强度: <span id="precipitation-intensity-value">-- mm/min</span></div>
          </div>
        </div>
        <div class="metric-card rounded-2xl p-6 hover-lift">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-indigo-500/20 rounded-xl flex items-center justify-center">
              <i data-lucide="clock" class="w-6 h-6 text-indigo-400"></i>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-white" id="timestamp-value">--:--</div>
              <div class="text-sm text-white/60">最后更新</div>
            </div>
          </div>
          <div class="text-xs text-white/50" id="status-text">正在获取数据...</div>
        </div>
      </div>
    </section>

    <!-- Quick Preview Chart -->
    <section class="mb-16" data-aos="fade-up" data-aos-delay="400">
      <div class="glass-effect rounded-3xl p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-white">24小时数据趋势</h3>
          <div class="flex items-center space-x-2 text-white/70 text-sm">
            <i data-lucide="trending-up" class="w-4 h-4"></i>
            <span>实时更新</span>
          </div>
        </div>
        <div class="chart-container">
          <div id="preview-chart" style="width: 100%; height: 300px;"></div>
        </div>
      </div>
    </section>

    <!-- Features Grid -->
    <section class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16" data-aos="fade-up" data-aos-delay="600">
      <div class="glass-effect rounded-2xl p-6 hover-lift">
        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mb-4">
          <i data-lucide="shield-check" class="w-6 h-6 text-blue-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">智能预警</h3>
        <p class="text-white/70">基于机器学习算法，实时分析传感器数据，提前预警潜在故障。</p>
      </div>

      <div class="glass-effect rounded-2xl p-6 hover-lift">
        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-4">
          <i data-lucide="wifi" class="w-6 h-6 text-green-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">远程监控</h3>
        <p class="text-white/70">支持远程访问，随时随地查看线缆运行状态和历史数据。</p>
      </div>

      <div class="glass-effect rounded-2xl p-6 hover-lift">
        <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center mb-4">
          <i data-lucide="database" class="w-6 h-6 text-purple-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">数据存储</h3>
        <p class="text-white/70">长期存储监测数据，支持历史查询和趋势分析。</p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="glass-effect border-t border-white/20 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <p class="text-white/60">© 2025 Linescope Server · 吉林线缆监测项目</p>
        <p class="text-white/40 text-sm mt-2">基于STM32 + Python Flask 构建</p>
      </div>
    </div>
  </footer>

  <!-- 现代化模块化JavaScript with enhanced loading -->
  <script type="module">
    // 性能优化的库初始化
    class LibraryLoader {
      constructor() {
        this.loadAttempts = 0;
        this.maxRetries = 3;
        this.retryDelay = 1000;
      }
      
      async waitForLibrary(globalName, timeout = 5000) {
        const start = Date.now();
        while (typeof window[globalName] === 'undefined') {
          if (Date.now() - start > timeout) {
            throw new Error(`${globalName} failed to load within ${timeout}ms`);
          }
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        return window[globalName];
      }
      
      async initializeLibraries() {
        const loadPromises = [];
        
        // 初始化Lucide图标（带容错）
        if (!window.lucideLoadError) {
          loadPromises.push(
            this.waitForLibrary('lucide', 3000)
              .then(() => {
                lucide.createIcons();
                console.log('✅ Lucide icons loaded');
              })
              .catch(() => console.warn('⚠️ Lucide icons not available'))
          );
        }
        
        // 初始化AOS动画（带容错）
        if (!window.aosLoadError) {
          loadPromises.push(
            this.waitForLibrary('AOS', 3000)
              .then(() => {
                AOS.init({
                  duration: 1000,
                  once: true,
                  offset: 100,
                  disable: window.matchMedia('(prefers-reduced-motion: reduce)').matches
                });
                console.log('✅ AOS animations loaded');
              })
              .catch(() => console.warn('⚠️ AOS animations not available'))
          );
        }
        
        // 检查ECharts加载状态
        if (!window.echartsLoadError) {
          loadPromises.push(
            this.waitForLibrary('echarts', 5000)
              .then(() => console.log('✅ ECharts loaded'))
              .catch(() => {
                console.warn('⚠️ ECharts not available');
                window.echartsLoadError = true;
              })
          );
        }
        
        try {
          await Promise.allSettled(loadPromises);
        } catch (error) {
          console.warn('Some libraries failed to load:', error);
        }
      }
    }
    
    // DOM加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        const loader = new LibraryLoader();
        await loader.initializeLibraries();
      });
    } else {
      const loader = new LibraryLoader();
      await loader.initializeLibraries();
    }
  </script>
  
  <!-- 性能监控模块 -->
  <script type="module" src="{{ url_for('static', filename='js/performance-monitor.js') }}"></script>
  
  <!-- 主应用模块 -->
  <script type="module" src="{{ url_for('static', filename='js/app.js') }}"></script>
  
  <!-- Service Worker Registration for PWA and Caching -->
  <script>
    // Service Worker 注册与管理
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          console.log('[SW] Registering Service Worker...');
          const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/',
            updateViaCache: 'none'
          });
          
          console.log('[SW] Service Worker registered:', registration.scope);
          
          // 监听Service Worker更新
          registration.addEventListener('updatefound', () => {
            console.log('[SW] New version available');
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[SW] New version installed, refresh to activate');
                // 可选：显示更新提示
                showUpdateNotification();
              }
            });
          });
          
          // 检查是否有等待中的Service Worker
          if (registration.waiting) {
            showUpdateNotification();
          }
          
        } catch (error) {
          console.warn('[SW] Service Worker registration failed:', error);
        }
      });
      
      // 监听Service Worker消息
      navigator.serviceWorker.addEventListener('message', (event) => {
        const { type, payload } = event.data;
        console.log('[SW] Message received:', type, payload);
      });
    }
    
    // 显示更新提示（可选实现）
    function showUpdateNotification() {
      console.log('[SW] App update available');
      // 这里可以实现用户友好的更新提示UI
      // 例如：显示"新版本可用，点击刷新"的提示条
    }
    
    // 缓存管理工具（开发调试用）
    window.cacheManager = {
      // 清空所有缓存
      async clearAll() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          const channel = new MessageChannel();
          return new Promise((resolve) => {
            channel.port1.onmessage = (event) => resolve(event.data);
            navigator.serviceWorker.controller.postMessage(
              { type: 'CLEAR_CACHE' }, 
              [channel.port2]
            );
          });
        }
      },
      
      // 获取缓存状态
      async getStatus() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          const channel = new MessageChannel();
          return new Promise((resolve) => {
            channel.port1.onmessage = (event) => resolve(event.data);
            navigator.serviceWorker.controller.postMessage(
              { type: 'CACHE_STATUS' },
              [channel.port2]
            );
          });
        }
      }
    };
  </script>
</body>
</html>
